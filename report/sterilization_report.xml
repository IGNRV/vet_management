<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <!-- ===== Paperformat SIN header reservado para este reporte (válido en Odoo 17) ===== -->
    <record id="paperformat_sterilization_noheader" model="report.paperformat">
      <field name="name">Sterilization PDF (no header)</field>
      <field name="format">A4</field>
      <field name="orientation">Portrait</field>
      <!-- Márgenes ajustados: sin header, dejamos un top pequeño -->
      <field name="margin_top">6</field>
      <field name="margin_bottom">8</field>
      <field name="margin_left">10</field>
      <field name="margin_right">10</field>
      <!-- Clave: no reservar espacio de encabezado -->
      <field name="header_line">False</field>
      <field name="header_spacing">0</field>
    </record>

    <!-- Acción de reporte PDF -->
    <record id="action_report_sterilization" model="ir.actions.report">
      <field name="name">Ficha de Esterilización</field>
      <field name="model">animal.sterilization</field>
      <field name="report_type">qweb-pdf</field>
      <field name="report_name">vet_management.report_sterilization</field>
      <field name="report_file">vet_management.report_sterilization</field>
      <!-- Usamos el paperformat sin header -->
      <field name="paperformat_id" ref="vet_management.paperformat_sterilization_noheader"/>
      <!-- Nombre dinámico del archivo -->
      <field name="print_report_name">
        (object.patient_name or 'Esterilizacion') + ' - Ficha.pdf'
      </field>
    </record>

    <!-- Contenedor por registro -->
    <template id="report_sterilization">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="doc">
          <t t-call="vet_management.report_sterilization_document"/>
          <div class="pagebreak"/>
        </t>
      </t>
    </template>

    <!-- Documento (volvemos a usar web.external_layout para asegurar <meta charset="utf-8">) -->
    <template id="report_sterilization_document">
      <t t-set="o" t-value="doc"/>
      <t t-call="web.external_layout">
        <div class="oe_structure"/>
        <style type="text/css">
          /* Fuente con buen soporte de tildes y ✓ */
          .stz { font-family: "DejaVu Sans", sans-serif; }

          .stz * { font-size: 11px; }
          .stz .title { font-size: 18px; font-weight: 700; }
          .stz .subtitle { font-size: 12px; }
          .stz table { width: 100%; border-collapse: collapse; }
          .stz th, .stz td { border: 1px solid #555; padding: 4px 6px; vertical-align: middle; }
          .stz .noborder td, .stz .noborder th { border: 0; }
          /* Permite marcar celdas individuales sin borde */
          .stz td.noborder, .stz th.noborder { border: 0 !important; }
          .stz .section { background: #eee; font-weight: 700; }
          .stz .checkbox { display:inline-block; border:1px solid #555; width:12px; height:12px; margin-right:4px; text-align:center; line-height:12px; }
          .stz .center { text-align: center; }
          .stz .right { text-align: right; }
          .stz .small { font-size: 10px; }
          .stz .microchip-box { border:1px solid #555; height:40px; }
          .stz .pagebreak { page-break-after: always; }
          .stz .sig { height:60px; }
          .stz .muted { color:#666; }
          .stz .line { display:inline-block; border-bottom:1px solid #555; min-width:140px; height:14px; vertical-align:bottom; }

          /* ===== Bloques de firma sin tablas (evitan cualquier recuadro) ===== */
          .stz .signrow { display: table; width: 100%; margin-top: 45px; }
          .stz .signcol { display: table-cell; width: 50%; padding: 0 6px; vertical-align: top; }

          /* Aumentamos el área en blanco para firmar (más espacio arriba de la línea) */
          .stz .signbox { text-align: center; padding-top: 140px; min-height: 180px; }

          /* Línea de firma visible justo encima del texto */
          .stz .sigline { border-top: 1px solid #555; margin: 0 12% 8px; height: 0; }
          .stz .siglabel { font-size: 15px; }

          /* Anular bordes SOLO en los contenedores, no en la línea */
          .stz .signrow,
          .stz .signcol,
          .stz .signbox,
          .stz .siglabel { border: 0 !important; outline: none !important; }

          /* ===== Ocultar el pie y el header estándar SOLO en este reporte ===== */
          .footer,
          .o_footer,
          .o_report_layout_standard .footer,
          .o_report_layout_boxed .footer,
          .o_report_layout_bold .footer,
          .header,
          .o_header,
          .o_report_layout_standard .header,
          .o_report_layout_boxed .header,
          .o_report_layout_bold .header {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            border: 0 !important;
          }
          .footer * { border: 0 !important; }

          /* ===== Imagen de cabecera (título) ===== */
          .stz .title-image {
            max-height: 70px;     /* ajusta si quieres más alto/bajo */
            width: auto;
            display: block;
          }
        </style>

        <div class="stz">

          <!-- Cabecera: imagen (izquierda) + microchip (derecha) -->
          <table class="noborder">
            <tr>
              <td class="noborder" style="width:65%; vertical-align:middle;">
                <!-- Se inyecta via parser como base64 para evitar problemas de rutas en wkhtmltopdf -->
                <img class="title-image"
                     t-if="stz_title_image"
                     t-att-src="'data:image/png;base64,%s' % (stz_title_image)"
                     alt="Esterilización - Ficha de Identificación, Consentimiento y Declaración simple"/>
              </td>
              <td class="noborder" style="width:35%">
                <table>
                  <tr>
                    <th class="center">Etiqueta del Microchip</th>
                  </tr>
                  <tr>
                    <td class="microchip-box center small">
                      <t t-esc="o.animal_id and (o.animal_id.microchip_number or '')"/>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>

          <!-- Datos responsable -->
          <table>
            <tr><th colspan="8" class="section">Datos responsable</th></tr>
            <tr>
              <td style="width:12%">Fecha:</td>
              <td style="width:13%"><span t-field="o.date"/></td>
              <td style="width:8%">RUT:</td>
              <td style="width:17%"><span t-esc="o.resp_rut or ''"/></td>
              <td style="width:16%">Fecha de nacimiento:</td>
              <td style="width:14%"><span t-field="o.resp_birthdate"/></td>
              <td style="width:8%">Teléfono 1:</td>
              <td style="width:12%"><span t-esc="o.resp_phone1 or ''"/></td>
            </tr>
            <tr>
              <td>Nombre:</td>
              <td colspan="3"><span t-esc="o.resp_name or ''"/></td>
              <td>Teléfono 2:</td>
              <td><span t-esc="o.resp_phone2 or ''"/></td>
              <td>Mail:</td>
              <td><span t-esc="o.resp_email or ''"/></td>
            </tr>
            <tr>
              <td>Dirección:</td>
              <td colspan="5"><span t-esc="o.resp_address or ''"/></td>
              <td>Comuna:</td>
              <td><span t-esc="o.resp_commune or ''"/></td>
            </tr>
            <tr>
              <td>Región:</td>
              <td colspan="3"><span t-esc="o.resp_region or ''"/></td>
              <td class="center" colspan="2">¿Es dueño/a de la mascota?</td>
              <td colspan="2">
                <span class="checkbox" t-esc=" '✔' if o.resp_is_owner else '' "/> Sí
                &#160;&#160;&#160;
                <span class="checkbox" t-esc=" '✔' if not o.resp_is_owner else '' "/> No
              </td>
            </tr>
          </table>

          <!-- Datos Paciente -->
          <table>
            <tr><th colspan="12" class="section">Datos Paciente</th></tr>
            <tr>
              <td style="width:10%">Nombre</td>
              <td style="width:16%"><span t-esc="o.patient_name or (o.animal_id and o.animal_id.name) or ''"/></td>
              <td style="width:10%">Especie</td>
              <!-- Antes: dict(o._fields['specie'].selection).get(o.specie) -->
              <td style="width:12%"><span t-esc="o.specie_id and o.specie_id.name or ''"/></td>
              <td style="width:8%">Sexo</td>
              <td style="width:10%"><span t-esc="dict(o._fields['sex'].selection).get(o.sex) if o.sex else ''"/></td>
              <td style="width:8%">Raza</td>
              <!-- Antes: o.breed_text -->
              <td style="width:10%"><span t-esc="o.breed_id and o.breed_id.name or ''"/></td>
              <td style="width:8%">Color</td>
              <td style="width:8%"><span t-esc="o.color or ''"/></td>
              <td style="width:4%">Patrón</td>
              <td style="width:6%"><span t-esc="o.pattern or ''"/></td>
            </tr>
            <tr>
              <td>Fecha Nacimiento</td>
              <td><span t-field="o.patient_birthdate"/></td>
              <td>Peso (Kg)</td>
              <td><span t-esc="o.weight or ''"/></td>
              <td>Tipo Tenencia</td>
              <td><span t-esc="dict(o._fields['tenancy_type'].selection).get(o.tenancy_type) if o.tenancy_type else ''"/></td>
              <td>Comuna Obtención</td>
              <td><span t-esc="o.commune_obtention or ''"/></td>
              <td>N° animales casa</td>
              <td colspan="3"><span t-esc="o.animals_at_home or ''"/></td>
            </tr>
            <tr>
              <td>Obtención</td>
              <td colspan="3"><span t-esc="dict(o._fields['obtention'].selection).get(o.obtention) if o.obtention else ''"/></td>
              <td>Razón tenencia</td>
              <td colspan="5"><span t-esc="dict(o._fields['tenure_reason'].selection).get(o.tenure_reason) if o.tenure_reason else ''"/></td>
              <td colspan="2"><span t-esc="o.tenure_reason_other if (o.tenure_reason == 'otro') else ''"/></td>
            </tr>
            <tr>
              <td>¿Mascota ya esterilizada?</td>
              <td colspan="2">
                <span class="checkbox" t-esc=" '✔' if o.already_sterilized else '' "/> Sí
                &#160;&#160;&#160;
                <span class="checkbox" t-esc=" '✔' if (o.already_sterilized is False) else '' "/> No
              </td>
              <td class="center">¿Ha asistido antes al Médico Veterinario?</td>
              <td colspan="3">
                <span class="checkbox" t-esc=" '✔' if o.visited_vet_before == 'si' else '' "/> Sí
                &#160;&#160;&#160;
                <span class="checkbox" t-esc=" '✔' if o.visited_vet_before == 'no' else '' "/> No
                &#160;&#160;&#160;
                <span class="checkbox" t-esc=" '✔' if o.visited_vet_before == 'ns' else '' "/> N/S
              </td>
              <td class="center">¿Microchip implantado hoy?</td>
              <td colspan="4">
                <span class="checkbox" t-esc=" '✔' if o.microchip_today else '' "/> Sí
                &#160;&#160;&#160;
                <span class="checkbox" t-esc=" '✔' if (o.microchip_today is False) else '' "/> No
              </td>
            </tr>
          </table>

          <!-- Procedimiento -->
          <table>
            <tr><th colspan="8" class="section">Procedimiento</th></tr>
            <tr>
              <td style="width:14%">Procedimiento</td>
              <td style="width:20%"><span t-esc="dict(o._fields['procedure_type'].selection).get(o.procedure_type) if o.procedure_type else ''"/></td>
              <td style="width:18%">Abordaje</td>
              <td style="width:16%">
                <span t-esc="dict(o._fields['ovario_approach'].selection).get(o.ovario_approach) if (o.procedure_type == 'ovariohisterectomia' and o.ovario_approach) else ''"/>
              </td>
              <td style="width:16%">Técnica</td>
              <td colspan="3">
                <span t-esc="dict(o._fields['orchiectomy_type'].selection).get(o.orchiectomy_type) if (o.procedure_type == 'orquiectomia' and o.orchiectomy_type) else ''"/>
              </td>
            </tr>

            <!-- Fila de datos de médico y RUT (sin el bloque de firma dentro de la tabla con bordes) -->
            <tr>
              <td>Nombre M.veterinario/a</td>
              <td><span t-esc="o.vet_name or ''"/></td>
              <td>RUT</td>
              <td><span t-esc="o.vet_rut or ''"/></td>
              <!-- Reservamos el espacio restante sin bordes -->
              <td class="noborder" colspan="4"></td>
            </tr>
          </table>

          <!-- Bloque de firma y timbre SIN BORDES -->
          <table class="noborder" style="margin-top:4px;">
            <tr class="noborder">
              <td class="noborder" style="width:20%;">Firma y timbre</td>
              <td class="noborder center" style="width:80%; height:60px;">
                <img t-if="o.signature" t-att-src="image_data_uri(o.signature)" style="max-height:60px;"/>
              </td>
            </tr>
          </table>

          <!-- Resultado procedimientos -->
          <table>
            <tr><th colspan="8" class="section">Resultado procedimientos</th></tr>
            <tr>
              <td style="width:16%">Esterilización - Estado</td>
              <td style="width:84%" colspan="7">
                <span class="checkbox" t-esc=" '✔' if o.status == 'exito' else '' "/> finalizado con éxito
                &#160;&#160;&#160;
                <span class="checkbox" t-esc=" '✔' if o.status == 'suspendido' else '' "/> suspendido
                &#160;&#160;&#160;
                <span class="checkbox" t-esc=" '✔' if o.status == 'rechazado' else '' "/> rechazado
                &#160;&#160;&#160;
                <span class="checkbox" t-esc=" '✔' if o.status == 'fallecido' else '' "/> fallecido
              </td>
            </tr>
            <tr>
              <td>Causa defunción</td>
              <td colspan="3"><span t-esc="o.death_cause if (o.status == 'fallecido') else ''"/></td>
              <td>Momento de defunción</td>
              <td colspan="2">
                <span t-esc="dict(o._fields['death_moment'].selection).get(o.death_moment) if (o.status == 'fallecido' and o.death_moment) else ''"/>
              </td>
              <td>Fecha defunción</td>
              <td><span t-field="o.death_date"/></td>
            </tr>
          </table>

          <!-- Autorización -->
          <table>
            <tr><th class="section">Autorización</th></tr>
            <tr>
              <td class="small">
                Mediante el presente documento autorizo a realizar el procedimiento de Esterilización al paciente individualizado en esta ficha,
                el que es de mi propiedad o del cual me haré responsable para efectos de los cuidados.
                &#160;&#160;&#160;&#160;[ ] Sí &#160;&#160;&#160; [ ] No
              </td>
            </tr>
          </table>

          <!-- Esterilización (texto completo) -->
          <table>
            <tr><th class="section">Esterilización</th></tr>
            <tr>
              <td class="small">
                Declaro que me han explicado detalladamente el procedimiento quirúrgico al que será sometida mi mascota y manifiesto entender que se extraerán definitivamente los órganos reproductores de ésta.<br/>
                Se me ha explicado además que, por su naturaleza, este procedimiento involucra riesgos generales y complicaciones que, a pesar de todas las medidas y cuidados efectuados por el equipo médico, pueden ser inevitables y en un bajo porcentaje de los casos llegar incluso a causar la muerte de mi mascota.<br/>
                Además declaro estar en conocimiento y consentir que, como todo procedimiento quirúrgico, requiere sedación y anestesia general, lo que puede estar asociado a complicaciones propias de su ejecución.<br/>
                Entiendo que siempre existe una posibilidad de que, en beneficio del paciente, el cirujano suspenda la cirugía o que varíe la técnica escogida previamente.<br/>
                Sé que todo procedimiento tiene limitaciones donde a veces no se logran los beneficios esperados, que ante la obtención de resultados parciales y/o complicaciones se hace necesario re intervenir o realizar procedimientos complementarios, que depende de factores variables e inadvertidos, y que en tal caso deberé asumir los gastos que ello implique.<br/>
                Declaro que he entregado información veraz sobre la salud de mi mascota y si ésta ha presentado en estos últimos 10 días: vómitos, diarrea, tos, secreciones oculares y nasales, descoordinación, anorexia, traumas, convulsiones.<br/>
                Manifiesto que toda la información entregada para la confección de esta ficha es fidedigna.<br/>
                Declaro cumplir con las horas de ayuno de agua y alimento que me indicaron para mi mascota y traer los implementos solicitados. Acepto que una de sus orejas será tatuada con la finalidad de registrar que fue esterilizado.<br/>
                Entiendo y acepto que tener a un animal sin dueño no implica la propiedad de él, sin embargo, sí implica la responsabilidad de los cuidados e indicaciones hasta su recuperación.<br/>
                Declaro no me encuentro afecto a la Inhabilidad absoluta y perpetua para la Tenencia de Animales, pena por simple delito contemplada en el Artículo 21 del Código Penal, para las personas que sean condenadas por el Delito de Maltrato o Crueldad Animal tipificado en el Artículo 291 Bis y Ter del Código Penal.
              </td>
            </tr>
          </table>

          <!-- Registro e Identificación -->
          <table>
            <tr><th class="section">Registro e Identificación</th></tr>
            <tr>
              <td class="small">
                Declaro entender que a mi mascota se le ha implantado un microchip, dispositivo electrónico subcutáneo que contiene un número único que será vinculado a mis datos personales. Autorizo a la municipalidad para efectuar la inscripción de mi mascota en el Registro Nacional de Mascotas o Animales de Compañía. Autorizo el despliegue de mis datos: Teléfono Fijo, Teléfono Celular y Correo Electrónico en caso de extravío de mi(s) mascota(s).
              </td>
            </tr>
          </table>

          <!-- Egreso -->
          <table>
            <tr><th class="section">Egreso</th></tr>
            <tr>
              <td class="small">
                Declaro que he recibido a mi mascota y el documento de cuidados post operatorios. Se me ha explicado y entiendo las indicaciones de los cuidados que debo realizar, asumiendo total responsabilidad durante este proceso. Entiendo los riesgos que existen para el bienestar y la recuperación del paciente si no efectúo las indicaciones que me entregaron. Me adhiero a la receta, controles y otros que me hayan señalado.<br/>
                He sido instruido en que si mi mascota presenta signos de decaimiento, falta de apetito, vómitos, diarrea, hemorragias, aumento de volumen, secreciones, fiebre, dolor, dificultad respiratoria, convulsiones u otros signos de alarma, debo llevarla inmediatamente a control.
              </td>
            </tr>
            <tr>
              <td>
                Mi mascota ha sido entregada:
                &#160; <span class="checkbox"/> viva
                &#160;&#160;&#160;
                <span class="checkbox"/> fallecida
              </td>
            </tr>
            <tr>
              <td>
                Estado:
                &#160; <span class="checkbox"/> consciente
                &#160;&#160;&#160; <span class="checkbox"/> se levanta sola
                &#160;&#160;&#160; <span class="checkbox"/> limpia
                &#160;&#160;&#160; <span class="checkbox"/> identidad corroborada con microchip
                &#160;&#160;&#160; <span class="checkbox"/> herida sin sangre
              </td>
            </tr>
          </table>

          <!-- Observaciones -->
          <table>
            <tr><th class="section">Observaciones / Notas</th></tr>
            <tr>
              <td style="height:120px;">
                <span t-esc="o.notes or ''"/>
              </td>
            </tr>
          </table>

          <!-- Firmas (sin tablas, sin recuadros) -->
          <div class="signrow">
            <div class="signcol">
              <div class="signbox">
                <div class="sigline"></div>
                <div class="siglabel">Firma Responsable</div>
              </div>
            </div>
            <div class="signcol">
              <div class="signbox">
                <div class="sigline"></div>
                <div class="siglabel">Timbre / Firma Clínica</div>
              </div>
            </div>
          </div>

        </div>
      </t>
    </template>

  </data>
</odoo>