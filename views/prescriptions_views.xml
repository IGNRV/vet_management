<odoo>
  <data>

    <!-- LISTA -->
    <record id="prescription_tree_view" model="ir.ui.view">
      <field name="name">animal.prescription.tree.view</field>
      <field name="model">animal.prescription</field>
      <field name="arch" type="xml">
        <tree string="Recetas">
          <field name="sequence"/>
          <field name="date"/>
          <field name="animal_id"/>
          <field name="owner_id"/>
          <field name="doctor_name"/>
          <field name="state"/>
        </tree>
      </field>
    </record>

    <!-- BÚSQUEDA -->
    <record id="prescription_search_view" model="ir.ui.view">
      <field name="name">animal.prescription.search.view</field>
      <field name="model">animal.prescription</field>
      <field name="arch" type="xml">
        <search>
          <field name="sequence"/>
          <field name="animal_id"/>
          <field name="owner_id"/>
          <field name="doctor_name"/>
          <filter name="state_draft" string="Borrador" domain="[('state','=','draft')]"/>
          <filter name="state_issued" string="Emitida/Firmada" domain="[('state','=','issued')]"/>
          <filter name="state_cancelled" string="Cancelada" domain="[('state','=','cancelled')]"/>
          <group expand="0" string="Agrupar por">
            <filter name="grp_animal" string="Animal" context="{'group_by':'animal_id'}"/>
            <filter name="grp_owner" string="Dueño" context="{'group_by':'owner_id'}"/>
            <filter name="grp_doctor" string="Médico" context="{'group_by':'doctor_name'}"/>
            <filter name="grp_state" string="Estado" context="{'group_by':'state'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- FORMULARIO -->
    <record id="prescription_form_view" model="ir.ui.view">
      <field name="name">animal.prescription.form.view</field>
      <field name="model">animal.prescription</field>
      <field name="arch" type="xml">
        <form string="Receta">
          <header>
            <!-- Odoo 17: reemplazo de 'states' por 'invisible' con dominios -->
            <button name="action_issue"
                    type="object"
                    string="Marcar como Emitida"
                    class="btn-primary"
                    invisible="[('state','!=','draft')]"/>
            <button name="action_reset_to_draft"
                    type="object"
                    string="Volver a borrador"
                    invisible="[('state','not in',['issued','cancelled'])]"/>
            <button name="action_cancel"
                    type="object"
                    string="Cancelar"
                    invisible="[('state','not in',['draft','issued'])]"/>
            <button name="%(action_report_prescription)d"
                    string="Imprimir Receta"
                    type="action"
                    class="btn-secondary"/>
            <field name="state" widget="statusbar" statusbar_visible="draft,issued,cancelled"/>
          </header>
          <sheet>
            <group>
              <group>
                <field name="sequence" readonly="1"/>
                <field name="date"/>
                <field name="animal_id" options="{'no_create': True, 'no_create_edit': True}"/>
                <field name="owner_id" readonly="1"/>
              </group>
              <group>
                <field name="doctor_name" placeholder="Nombre del profesional"/>
                <field name="doctor_rut" placeholder="12.345.678-9"/>
                <field name="duration_days"/>
                <field name="next_control"/>
              </group>
            </group>

            <notebook>
              <page string="Contenido">
                <group>
                  <field name="diagnosis" placeholder="Diagnóstico clínico o presuntivo..."/>
                  <field name="rp" placeholder="Rp: medicamento(s), concentración, forma farmacéutica, dosis, intervalos, duración..."/>
                  <field name="indications" placeholder="Indicaciones y recomendaciones al propietario..."/>
                </group>
              </page>
              <page string="Paciente (solo lectura)">
                <group>
                  <group>
                    <field name="specie_id" readonly="1"/>
                    <field name="breed_id" readonly="1"/>
                    <field name="sex" readonly="1"/>
                    <field name="microchip_number" readonly="1"/>
                  </group>
                </group>
              </page>
              <page string="Firmas">
                <group>
                  <group string="Firma Propietario/a">
                    <field name="owner_signature" widget="signature" class="oe_inline"/>
                  </group>
                  <group string="Firma Médico Veterinario">
                    <field name="doctor_signature" widget="signature" class="oe_inline"/>
                  </group>
                </group>
              </page>
              <page string="Notas">
                <group>
                  <field name="notes"/>
                </group>
              </page>
            </notebook>
          </sheet>
          <div class="oe_chatter">
            <field widget="mail_thread" name="message_ids"/>
            <field widget="mail_activity" name="activity_ids"/>
          </div>
        </form>
      </field>
    </record>

    <!-- ACCIÓN -->
    <record id="prescription_action" model="ir.actions.act_window">
      <field name="name">Recetas</field>
      <field name="res_model">animal.prescription</field>
      <field name="view_mode">search,tree,form</field>
      <field name="search_view_id" ref="prescription_search_view"/>
      <field name="view_id" ref="prescription_tree_view"/>
    </record>

  </data>
</odoo>
