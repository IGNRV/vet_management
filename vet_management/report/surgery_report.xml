<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <!-- Paperformat SIN header reservado (Odoo 17) -->
    <record id="paperformat_surgery_noheader" model="report.paperformat">
      <field name="name">Surgery PDF (no header)</field>
      <field name="format">A4</field>
      <field name="orientation">Portrait</field>
      <field name="margin_top">6</field>
      <field name="margin_bottom">8</field>
      <field name="margin_left">10</field>
      <field name="margin_right">10</field>
      <field name="header_line">False</field>
      <field name="header_spacing">0</field>
    </record>

    <!-- Acción de reporte PDF -->
    <record id="action_report_surgery" model="ir.actions.report">
      <field name="name">Acta Quirúrgica</field>
      <field name="model">animal.surgery.record</field>
      <field name="report_type">qweb-pdf</field>
      <field name="report_name">vet_management.report_surgery</field>
      <field name="report_file">vet_management.report_surgery</field>
      <field name="paperformat_id" ref="vet_management.paperformat_surgery_noheader"/>
      <field name="print_report_name">
        (object.sequence or 'Cirugia') + ' - ' + (object.animal_id and object.animal_id.name or 'Paciente') + '.pdf'
      </field>
    </record>

    <!-- Contenedor por registro -->
    <template id="report_surgery">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="doc">
          <t t-call="vet_management.report_surgery_document"/>
          <div class="pagebreak"/>
        </t>
      </t>
    </template>

    <!-- Documento -->
    <template id="report_surgery_document">
      <t t-set="o" t-value="doc"/>
      <t t-call="web.external_layout">
        <style type="text/css">
          .srg * { font-size: 12px; font-family: "DejaVu Sans", sans-serif; }
          .srg .title { font-size: 18px; font-weight: 700; text-align:center; }
          .srg table { width: 100%; border-collapse: collapse; }
          .srg th, .srg td { border: 0; padding: 4px 6px; vertical-align: top; }
          .srg .section { font-weight: 700; text-align:center; border: 1px solid #000; background: #f3f3f3; }
          .srg .boxed { border: 1px solid #000; }
          .srg .label { width: 22%; white-space: nowrap; }
          .srg .val { width: 28%; border-bottom: 1px solid #000; }
          .srg .val2 { border-bottom: 1px solid #000; }
          .srg .muted { color:#666; }
          .srg .header-strip { margin-bottom: 4px; }
          .srg .header-image { max-width: 100%; height: auto; display: block; margin: 0 auto; }
          .srg .small { font-size: 11px; }

          .footer,
          .o_footer,
          .header,
          .o_header {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            border: 0 !important;
          }
        </style>

        <div class="srg">

          <!-- Cabecera -->
          <div class="header-strip">
            <img class="header-image"
                 t-if="surg_header_image"
                 t-att-src="'data:image/png;base64,%s' % (surg_header_image)"
                 alt="Encabezado"/>
          </div>

          <div class="title" style="margin:6px 0;">
            ACTA QUIRÚRGICA
          </div>

          <!-- Propietario -->
          <table class="boxed" style="margin-top:6px;">
            <tr><th class="section" colspan="4">Información del propietario</th></tr>
            <tr>
              <td class="label">Nombre :</td>
              <td class="val"><t t-esc="o.owner_id and (o.owner_id.name or '')"/></td>
              <td class="label">RUT :</td>
              <td class="val"><t t-esc="o.owner_id and (o.owner_id.vat or '')"/></td>
            </tr>
            <tr>
              <td class="label">Teléfono :</td>
              <td class="val"><t t-esc="o.owner_id and (o.owner_id.phone or o.owner_id.mobile or '')"/></td>
              <td class="label">Correo :</td>
              <td class="val"><t t-esc="o.owner_id and (o.owner_id.email or '')"/></td>
            </tr>
            <tr>
              <td class="label">Dirección :</td>
              <td class="val" colspan="3"><t t-esc="o.owner_id and (o.owner_id.street or '')"/></td>
            </tr>
          </table>

          <!-- Paciente -->
          <table class="boxed" style="margin-top:8px;">
            <tr><th class="section" colspan="6">Información del paciente</th></tr>
            <tr>
              <td class="label">Nombre:</td>
              <td class="val"><t t-esc="o.animal_id and (o.animal_id.name or '')"/></td>
              <td class="label">Especie:</td>
              <td class="val"><t t-esc="o.specie_id and o.specie_id.name or ''"/></td>
              <td class="label">Microchip:</td>
              <td class="val"><t t-esc="o.microchip_number or ''"/></td>
            </tr>
            <tr>
              <td class="label">Sexo:</td>
              <td class="val"><t t-esc="({'male':'Macho','female':'Hembra'}).get(o.sex) if o.sex else ''"/></td>
              <td class="label">Raza:</td>
              <td class="val"><t t-esc="o.breed_id and o.breed_id.name or ''"/></td>
              <td class="label"></td>
              <td class="val"></td>
            </tr>
          </table>

          <!-- Detalle general -->
          <table class="boxed" style="margin-top:8px;">
            <tr><th class="section" colspan="4">Detalles</th></tr>
            <tr>
              <td class="label">Referencia:</td>
              <td class="val"><t t-esc="o.sequence or ''"/></td>
              <td class="label">Fecha/hora:</td>
              <td class="val"><span t-field="o.date" t-options='{"widget": "datetime"}'/></td>
            </tr>
            <tr>
              <td class="label">Cirugía:</td>
              <td class="val"><t t-esc="o.surgery_id and o.surgery_id.name or ''"/></td>
              <td class="label">Estado:</td>
              <td class="val"><t t-esc="dict(o._fields['state'].selection).get(o.state)"/></td>
            </tr>
            <tr>
              <td class="label">Cirujano/a:</td>
              <td class="val"><t t-esc="o.surgeon or ''"/></td>
              <td class="label">Anestesista:</td>
              <td class="val"><t t-esc="o.anesthetist or ''"/></td>
            </tr>
          </table>

          <!-- Preoperatorio -->
          <table class="boxed" style="margin-top:8px;">
            <tr><th class="section" colspan="4">Preoperatorio</th></tr>
            <tr>
              <td class="label">Ayuno (hrs):</td>
              <td class="val"><t t-esc="o.fasting_hours or ''"/></td>
              <td class="label">ASA:</td>
              <td class="val"><t t-esc="o.asa_status or ''"/></td>
            </tr>
            <tr>
              <td class="label" colspan="4">Evaluación / exámenes:</td>
            </tr>
            <tr>
              <td class="val2" colspan="4" style="height: 84px;"><t t-esc="o.preop_checks or ''"/></td>
            </tr>
            <tr>
              <td class="label" colspan="4">Diagnóstico preoperatorio:</td>
            </tr>
            <tr>
              <td class="val2" colspan="4" style="height: 70px;"><t t-esc="o.preop_diagnosis or ''"/></td>
            </tr>
          </table>

          <!-- Anestesia -->
          <table class="boxed" style="margin-top:8px;">
            <tr><th class="section" colspan="4">Anestesia</th></tr>
            <tr>
              <td class="label" colspan="4">Protocolo anestésico:</td>
            </tr>
            <tr>
              <td class="val2" colspan="4" style="height: 84px;"><t t-esc="o.anesthesia_protocol or ''"/></td>
            </tr>
            <tr>
              <td class="label">Fluidos (mL):</td>
              <td class="val"><t t-esc="o.fluids_ml or ''"/></td>
              <td class="label">Analgesia/ATB:</td>
              <td class="val"><t t-esc="o.analgesia or ''"/></td>
            </tr>
            <tr>
              <td class="label" colspan="4">Monitoreo / eventos:</td>
            </tr>
            <tr>
              <td class="val2" colspan="4" style="height: 70px;"><t t-esc="o.monitoring_notes or ''"/></td>
            </tr>
          </table>

          <!-- Procedimiento -->
          <table class="boxed" style="margin-top:8px;">
            <tr><th class="section" colspan="4">Procedimiento quirúrgico</th></tr>
            <tr>
              <td class="label">Lado/Abordaje:</td>
              <td class="val"><t t-esc="dict(o._fields['side'].selection).get(o.side) if o.side else ''"/></td>
              <td class="label">Herida (clasif.):</td>
              <td class="val"><t t-esc="dict(o._fields['wound_class'].selection).get(o.wound_class) if o.wound_class else ''"/></td>
            </tr>
            <tr>
              <td class="label">Pérdida sanguínea (mL):</td>
              <td class="val"><t t-esc="o.estimated_blood_loss_ml or ''"/></td>
              <td class="label"></td>
              <td class="val"></td>
            </tr>
            <tr>
              <td class="label" colspan="4">Detalles / técnica / hallazgos:</td>
            </tr>
            <tr>
              <td class="val2" colspan="4" style="height: 110px;"><t t-esc="o.procedure_details or ''"/></td>
            </tr>
            <tr>
              <td class="label">Muestras tomadas:</td>
              <td class="val" colspan="3"><t t-esc="o.samples_taken or ''"/></td>
            </tr>
            <tr>
              <td class="label">Complicaciones:</td>
              <td class="val" colspan="3"><t t-esc="o.complications or ''"/></td>
            </tr>
            <tr>
              <td class="label">Diagnóstico postoperatorio:</td>
              <td class="val" colspan="3"><t t-esc="o.postop_diagnosis or ''"/></td>
            </tr>
          </table>

          <!-- Consumos -->
          <table class="boxed" style="margin-top:8px;">
            <tr><th class="section">Consumos intra-quirúrgicos (stock)</th></tr>
            <tr>
              <td>
                <table style="width:100%;">
                  <thead>
                    <tr>
                      <th style="text-align:left;">Medicamento/Consumible</th>
                      <th style="text-align:left;">Cantidad (unid.)</th>
                      <th style="text-align:left;">Lote</th>
                      <th style="text-align:left;">Venc.</th>
                      <th style="text-align:left;">Notas</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr t-foreach="o.medication_line_ids" t-as="l">
                      <td><t t-esc="l.medicine_id and l.medicine_id.name or ''"/></td>
                      <td><t t-esc="l.quantity_units or ''"/></td>
                      <td><t t-esc="l.lot_number or ''"/></td>
                      <td><span t-field="l.lot_expiration" t-options='{"widget": "date"}'/></td>
                      <td><t t-esc="l.notes or ''"/></td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
          </table>

          <!-- Postoperatorio -->
          <table class="boxed" style="margin-top:8px;">
            <tr><th class="section" colspan="4">Postoperatorio</th></tr>
            <tr>
              <td class="label">Hospitalización:</td>
              <td class="val"><t t-esc=" 'Sí' if o.hospitalization else 'No' "/></td>
              <td class="label">Alta:</td>
              <td class="val"><span t-field="o.discharge_datetime" t-options='{"widget":"datetime"}'/></td>
            </tr>
            <tr>
              <td class="label">Próximo control:</td>
              <td class="val"><span t-field="o.next_control" t-options='{"widget":"date"}'/></td>
              <td class="label"></td>
              <td class="val"></td>
            </tr>
            <tr>
              <td class="label" colspan="4">Indicaciones:</td>
            </tr>
            <tr>
              <td class="val2" colspan="4" style="height: 110px;"><t t-esc="o.post_instructions or ''"/></td>
            </tr>
          </table>

          <div class="small muted" style="margin-top:6px;">
            Ref.: <t t-esc="o.sequence or ''"/> — Paciente: <t t-esc="o.animal_id and o.animal_id.name or ''"/>
          </div>
        </div>
      </t>
    </template>

  </data>
</odoo>
