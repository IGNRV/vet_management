<odoo>
  <data>

    <!-- ===================== CATÁLOGO DE CIRUGÍAS ===================== -->
    <record id="view_surgery_tree" model="ir.ui.view">
      <field name="name">animal.surgery.tree</field>
      <field name="model">animal.surgery</field>
      <field name="arch" type="xml">
        <tree>
          <field name="name"/>
          <field name="code"/>
          <field name="category"/>
          <field name="default_duration_min"/>
        </tree>
      </field>
    </record>

    <record id="view_surgery_form" model="ir.ui.view">
      <field name="name">animal.surgery.form</field>
      <field name="model">animal.surgery</field>
      <field name="arch" type="xml">
        <form string="Cirugía (catálogo)">
          <sheet>
            <group>
              <group>
                <field name="name"/>
                <field name="code"/>
                <field name="category"/>
              </group>
              <group>
                <field name="default_duration_min"/>
              </group>
            </group>
            <notebook>
              <page string="Descripción">
                <field name="description" nolabel="1"/>
              </page>
              <page string="Notas">
                <field name="notes" nolabel="1"/>
              </page>
            </notebook>
          </sheet>
        </form>
      </field>
    </record>

    <record id="action_surgery_catalog" model="ir.actions.act_window">
      <field name="name">Catálogo de cirugías</field>
      <field name="res_model">animal.surgery</field>
      <field name="view_mode">tree,form</field>
    </record>

    <!-- ===================== REGISTRO QUIRÚRGICO ===================== -->
    <record id="view_surgery_record_tree" model="ir.ui.view">
      <field name="name">animal.surgery.record.tree</field>
      <field name="model">animal.surgery.record</field>
      <field name="arch" type="xml">
        <tree>
          <field name="sequence"/>
          <field name="date"/>
          <field name="animal_id"/>
          <field name="surgery_id"/>
          <field name="surgeon"/>
          <field name="anesthetist"/>
          <field name="asa_status"/>
          <field name="duration_min"/>
          <field name="state"/>
        </tree>
      </field>
    </record>

    <record id="view_surgery_record_search" model="ir.ui.view">
      <field name="name">animal.surgery.record.search</field>
      <field name="model">animal.surgery.record</field>
      <field name="arch" type="xml">
        <search>
          <field name="sequence"/>
          <field name="animal_id"/>
          <field name="surgery_id"/>
          <field name="surgeon"/>
          <field name="anesthetist"/>
          <field name="asa_status"/>
          <filter name="scheduled" string="Programadas" domain="[('state','=','scheduled')]"/>
          <filter name="in_progress" string="En curso" domain="[('state','=','in_progress')]"/>
          <filter name="done" string="Completadas" domain="[('state','=','done')]"/>
          <filter name="cancelled" string="Canceladas" domain="[('state','=','cancelled')]"/>
          <group expand="0" string="Agrupar">
            <filter name="group_animal" string="Por animal" context="{'group_by':'animal_id'}"/>
            <filter name="group_surgeon" string="Por cirujano/a" context="{'group_by':'surgeon'}"/>
            <filter name="group_state" string="Por estado" context="{'group_by':'state'}"/>
            <filter name="group_date" string="Por fecha" context="{'group_by':'date'}"/>
          </group>
        </search>
      </field>
    </record>

    <record id="view_surgery_record_form" model="ir.ui.view">
      <field name="name">animal.surgery.record.form</field>
      <field name="model">animal.surgery.record</field>
      <field name="arch" type="xml">
        <form string="Registro quirúrgico">
          <header>
            <!-- Odoo 17: usar invisible="" en lugar de states="" -->
            <button name="action_start" string="Iniciar" type="object"
                    invisible="state != 'scheduled'" class="btn-primary"/>
            <button name="action_done" string="Finalizar" type="object"
                    invisible="state not in ('scheduled','in_progress')" class="btn-success"/>
            <button name="action_cancel" string="Cancelar" type="object"
                    invisible="state not in ('scheduled','in_progress')" class="btn-secondary"/>
            <button name="action_reset_to_scheduled" string="Volver a Programada" type="object"
                    invisible="state != 'cancelled'" class="btn-secondary"/>
            <field name="state" widget="statusbar" statusbar_visible="scheduled,in_progress,done,cancelled"/>
          </header>
          <sheet>
            <div class="oe_button_box" name="button_box"/>
            <group>
              <group>
                <field name="sequence" readonly="1"/>
                <field name="date"/>
                <field name="duration_min"/>
                <field name="animal_id" options="{'no_create': True}"/>
                <field name="owner_id" readonly="1"/>
              </group>
              <group>
                <field name="surgery_id" options="{'no_create': False}"/>
                <field name="surgeon"/>
                <field name="assistant"/>
                <field name="anesthetist"/>
                <field name="consent_id" options="{'no_create': True}"/>
              </group>
            </group>

            <notebook>
              <page string="Preoperatorio">
                <group>
                  <group>
                    <field name="preop_diagnosis" placeholder="Motivo/diagnóstico que indica cirugía..." nolabel="1"/>
                  </group>
                </group>
                <group>
                  <group>
                    <field name="fasting_hours"/>
                    <field name="asa_status"/>
                  </group>
                  <group>
                    <field name="preop_checks" placeholder="Exámenes, hallazgos, riesgos..."/>
                  </group>
                </group>
              </page>

              <page string="Anestesia">
                <group>
                  <group>
                    <field name="anesthesia_protocol" placeholder="Premedicación / Inducción / Mantenimiento"/>
                    <field name="analgesia" placeholder="Analgesia intra y postoperatoria, antibióticos..."/>
                  </group>
                  <group>
                    <field name="fluids_ml"/>
                    <label for="monitoring_notes"/>
                    <field name="monitoring_notes" placeholder="Eventos intraoperatorios, comentarios de monitorización..."/>
                  </group>
                </group>
                <group string="Signos vitales (opcional)">
                  <group>
                    <field name="vitals_hr"/>
                    <field name="vitals_rr"/>
                    <field name="vitals_temp"/>
                  </group>
                  <group>
                    <field name="vitals_spo2"/>
                    <field name="vitals_map"/>
                    <field name="vitals_etco2"/>
                  </group>
                </group>
              </page>

              <page string="Procedimiento">
                <group>
                  <group>
                    <field name="side"/>
                    <field name="wound_class"/>
                    <field name="estimated_blood_loss_ml"/>
                  </group>
                  <group>
                    <field name="procedure_details" placeholder="Técnica, hallazgos, pasos relevantes..." nolabel="1"/>
                  </group>
                </group>
                <group>
                  <group>
                    <field name="samples_taken" placeholder="Muestras tomadas / laboratorio..."/>
                  </group>
                  <group>
                    <field name="complications" placeholder="Complicaciones ocurridas..."/>
                  </group>
                </group>
                <group>
                  <group>
                    <field name="postop_diagnosis" placeholder="Diagnóstico postoperatorio" nolabel="1"/>
                  </group>
                </group>
              </page>

              <page string="Consumos (stock)">
                <field name="medication_line_ids" context="{'default_surgery_record_id': active_id}">
                  <tree editable="bottom">
                    <field name="medicine_id"/>
                    <field name="quantity_units"/>
                    <field name="lot_number"/>
                    <field name="lot_expiration"/>
                    <field name="consume_stock"/>
                    <field name="notes"/>
                  </tree>
                  <form string="Medicamento de cirugía">
                    <group>
                      <group>
                        <field name="medicine_id"/>
                        <field name="quantity_units"/>
                        <field name="consume_stock"/>
                      </group>
                      <group>
                        <field name="lot_number"/>
                        <field name="lot_expiration"/>
                        <field name="notes"/>
                      </group>
                    </group>
                  </form>
                </field>
              </page>

              <page string="Postoperatorio">
                <group>
                  <group>
                    <field name="hospitalization"/>
                    <field name="discharge_datetime"/>
                    <field name="next_control"/>
                  </group>
                  <group>
                    <field name="post_instructions" placeholder="Cuidados, collar isabelino, curaciones, controles, signos de alarma..." nolabel="1"/>
                  </group>
                </group>
                <group string="Adjuntos">
                  <field name="attachment_ids" widget="many2many_binary" options="{'no_create': True}"/>
                </group>
              </page>

              <page string="Paciente (referencia)">
                <group>
                  <group>
                    <field name="specie_id" readonly="1"/>
                    <field name="breed_id" readonly="1"/>
                    <field name="sex" readonly="1"/>
                  </group>
                  <group>
                    <field name="microchip_number" readonly="1"/>
                  </group>
                </group>
              </page>

              <page string="Notas">
                <field name="notes" nolabel="1"/>
              </page>
            </notebook>

            <div class="oe_chatter">
              <field name="message_follower_ids" widget="mail_followers"/>
              <field name="message_ids" widget="mail_thread"/>
            </div>
          </sheet>
        </form>
      </field>
    </record>

    <record id="action_surgery_record" model="ir.actions.act_window">
      <field name="name">Registro quirúrgico</field>
      <field name="res_model">animal.surgery.record</field>
      <field name="view_mode">tree,form</field>
      <field name="context">{'search_default_scheduled': 1}</field>
    </record>

    <!-- (Sin menús aquí para evitar duplicar IDs; los menús viven en animals_menus.xml) -->

  </data>
</odoo>
