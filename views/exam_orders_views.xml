<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <!-- ===== Search ===== -->
    <record id="exam_order_search_view" model="ir.ui.view">
      <field name="name">animal.exam.order.search.view</field>
      <field name="model">animal.exam.order</field>
      <field name="arch" type="xml">
        <search>
          <field name="sequence" string="Referencia"/>
          <field name="animal_id" string="Animal"/>
          <field name="owner_id" string="Dueño"/>
          <field name="date" string="Fecha"/>
          <field name="exam_type" string="Tipo de examen"/>
          <field name="priority" string="Prioridad"/>
          <field name="state" string="Estado"/>
          <field name="doctor" string="Dr/Dra"/>

          <group expand="0" string="Agrupar por">
            <filter name="grp_animal" string="Animal" context="{'group_by':'animal_id'}"/>
            <filter name="grp_owner" string="Dueño" context="{'group_by':'owner_id'}"/>
            <filter name="grp_exam_type" string="Tipo de examen" context="{'group_by':'exam_type'}"/>
            <filter name="grp_priority" string="Prioridad" context="{'group_by':'priority'}"/>
            <filter name="grp_state" string="Estado" context="{'group_by':'state'}"/>
            <filter name="grp_date" string="Fecha" context="{'group_by':'date:month'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- ===== Tree ===== -->
    <record id="exam_order_tree_view" model="ir.ui.view">
      <field name="name">animal.exam.order.tree.view</field>
      <field name="model">animal.exam.order</field>
      <field name="arch" type="xml">
        <tree string="Órdenes de Exámenes">
          <field name="sequence" string="Ref."/>
          <field name="date"/>
          <field name="animal_id"/>
          <field name="owner_id" string="Dueño"/>
          <field name="exam_type" string="Examen"/>
          <field name="priority" string="Prioridad"/>
          <field name="state" string="Estado"/>
        </tree>
      </field>
    </record>

    <!-- ===== Form ===== -->
    <record id="exam_order_form_view" model="ir.ui.view">
      <field name="name">animal.exam.order.form.view</field>
      <field name="model">animal.exam.order</field>
      <field name="arch" type="xml">
        <form string="Órdenes de Exámenes">
          <header>
            <button name="action_confirm" type="object" class="btn-primary" string="Confirmar"
                    invisible="state != 'draft'"/>
            <button name="action_done" type="object" class="btn-primary" string="Marcar como Completado"
                    invisible="state != 'ordered'"/>
            <button name="action_cancel" type="object" string="Cancelar"
                    invisible="not (state in ('draft','ordered'))"/>
            <button name="action_reset_to_draft" type="object" string="Restablecer a Borrador"
                    invisible="not (state in ('done','cancelled'))"/>

            <!-- Descarga de PDF de la ORDEN (visible al estar confirmada) -->
            <button name="%(action_report_exam_order)d"
                    type="action"
                    class="btn-secondary"
                    string="Descargar Orden PDF"
                    invisible="state != 'ordered'"/>

            <!-- Descarga de PDF con RESULTADOS (visible en menú 'Resultados de Exámenes' = state done) -->
            <button name="%(action_report_exam_order)d"
                    type="action"
                    class="btn-secondary"
                    string="Descargar Resultado PDF"
                    invisible="state != 'done'"/>

            <field name="state" widget="statusbar" statusbar_visible="draft,ordered,done,cancelled"/>
          </header>

          <sheet>
            <!-- Título: Referencia -->
            <group>
              <field class="fs-1" name="sequence"/>
            </group>

            <group>
              <!-- Columna derecha: datos administrativos -->
              <group string="Datos">
                <group>
                  <field name="animal_id"/>
                </group>
                <group>
                  <field name="owner_id" readonly="1"/>
                </group>
                <group col="4">
                  <field name="date" colspan="2"/>
                  <field name="doctor" string="Dr/Dra" placeholder="Nombre del profesional" colspan="2"/>
                </group>
              </group>

              <!-- Columna izquierda: detalle de la orden -->
              <group string="Detalle de la Orden" colspan="2">
                <group>
                  <field name="exam_type"/>
                  <field name="exam_type_other" invisible="exam_type != 'otro'"/>
                  <field name="priority"/>
                  <field name="notes" placeholder="Indicaciones para el laboratorio / paciente..."/>
                </group>
                <group>
                  <field name="results" placeholder="Resultados, observaciones o interpretación..."/>
                  <field name="attachment_ids" widget="many2many_binary" string="Adjuntos (PDF, imágenes, etc.)"/>
                </group>
              </group>
            </group>
          </sheet>

          <div class="oe_chatter">
            <field widget="mail_thread" name="message_ids"/>
            <field widget="mail_activity" name="activity_ids"/>
          </div>
        </form>
      </field>
    </record>

    <!-- ===== Action (todas las órdenes) ===== -->
    <record id="exam_order_action" model="ir.actions.act_window">
      <field name="name">Órdenes de Exámenes</field>
      <field name="res_model">animal.exam.order</field>
      <field name="view_mode">search,tree,form,kanban</field>
    </record>

    <!-- ===== Action (solo resultados/completadas) ===== -->
    <record id="exam_results_action" model="ir.actions.act_window">
      <field name="name">Resultados de Exámenes</field>
      <field name="res_model">animal.exam.order</field>
      <field name="view_mode">search,tree,form,kanban</field>
      <field name="domain">[('state', '=', 'done')]</field>
    </record>

  </data>
</odoo>
